name: âš¡ ìµœì†Œ ì†Œëª¨ ë°°í¬ (3-5ë¶„)

# ê·¹í•œ ìµœì í™”: ê¼­ í•„ìš”í•  ë•Œë§Œ ì‹¤í–‰
on:
  push:
    branches: [ main ]
    paths:
      - 'backend/src/**'      # ë°±ì—”ë“œ ì½”ë“œ ë³€ê²½ ì‹œì—ë§Œ
      - 'frontend/src/**'     # í”„ë¡ íŠ¸ì—”ë“œ ì½”ë“œ ë³€ê²½ ì‹œì—ë§Œ
      - 'backend/build.gradle' # ë¹Œë“œ ì„¤ì • ë³€ê²½ ì‹œì—ë§Œ

# ë™ì‹œ ì‹¤í–‰ 1ê°œë¡œ ì œí•œ
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===============================
  # ğŸš€ ì´ˆê³ ì† ë°°í¬ (í…ŒìŠ¤íŠ¸ ìµœì†Œí™”)
  # ===============================
  lightning-deploy:
    runs-on: ubuntu-latest
    # ì˜ˆìƒ ì†Œëª¨ëŸ‰: 3-5ë¶„
    
    steps:
    - uses: actions/checkout@v4
    
    # ë³‘ë ¬ ì²˜ë¦¬: í”„ë¡ íŠ¸ì—”ë“œ & ë°±ì—”ë“œ ë™ì‹œ ë¹Œë“œ
    - name: ğŸŸ¢ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: ./frontend/package-lock.json
    
    - name: â˜• JDK 17 ì„¤ì •  
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
    
    # í•µì‹¬ í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰ (30ì´ˆ)
    - name: ğŸ§ª ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸
      working-directory: ./backend
      run: |
        chmod +x gradlew
        ./gradlew compileJava compileTestJava --parallel
    
    # í”„ë¡ íŠ¸ì—”ë“œ & ë°±ì—”ë“œ ë¹Œë“œ ë³‘ë ¬ ì‹¤í–‰
    - name: ğŸ—ï¸ ë™ì‹œ ë¹Œë“œ
      run: |
        # í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ (ë°±ê·¸ë¼ìš´ë“œ)
        cd frontend && npm ci && npm run build &
        
        # ë°±ì—”ë“œ ë¹Œë“œ
        cd backend && ./gradlew bootJar -x test --parallel &
        
        # ë‘ ì‘ì—… ì™„ë£Œ ëŒ€ê¸°
        wait
      env:
        VITE_API_URL: ${{ secrets.BACKEND_URL }}
        SPRING_PROFILES_ACTIVE: prod
    
    # ë™ì‹œ ë°°í¬
    - name: ğŸš€ ë™ì‹œ ë°°í¬
      run: |
        # GitHub Pages ë°°í¬ (ë°±ê·¸ë¼ìš´ë“œ)
        npx gh-pages -d frontend/dist &
        
        # Railway ë°°í¬
        npx @railway/cli@latest login --token ${{ secrets.RAILWAY_TOKEN }}
        npx @railway/cli@latest link ${{ secrets.RAILWAY_PROJECT_ID }}  
        npx @railway/cli@latest up --detach &
        
        # ë°°í¬ ì™„ë£Œ ëŒ€ê¸°
        wait
        echo "âš¡ ì´ˆê³ ì† ë°°í¬ ì™„ë£Œ!"
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

# ===============================
# âš¡ ê·¹í•œ ìµœì í™” ê²°ê³¼
# ===============================
# ì†Œëª¨ëŸ‰: 3-5ë¶„ (75% ì ˆì•½!)
# ì›” 400íšŒ ë°°í¬ ê°€ëŠ¥ (ë¬´ë£Œ í”Œëœ)
# ===============================