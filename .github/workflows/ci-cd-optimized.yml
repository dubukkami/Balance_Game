name: ğŸš€ ìµœì í™”ëœ CI/CD Pipeline

# ===============================
# ğŸ¯ íŠ¸ë¦¬ê±° ìµœì í™” - ë¶ˆí•„ìš”í•œ ì‹¤í–‰ ë°©ì§€
# ===============================
on:
  push:
    branches: [ main ]  # develop ì œê±° (ê°œë°œìš©ì€ ë¡œì»¬ì—ì„œ)
    paths-ignore:       # ë¬¸ì„œ ë³€ê²½ ì‹œì—ëŠ” ì‹¤í–‰ ì•ˆí•¨
      - '*.md'
      - 'docs/**'
      - '.gitignore'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '*.md'
      - 'docs/**'
      - '.gitignore'

# ===============================
# ğŸ”„ ë™ì‹œ ì‹¤í–‰ ì œí•œ - ë¦¬ì†ŒìŠ¤ ì ˆì•½
# ===============================
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true  # ì´ì „ ì‹¤í–‰ ì¤‘ë‹¨í•˜ê³  ìƒˆë¡œìš´ ì‹¤í–‰

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ===============================
  # ğŸ§ª ë°±ì—”ë“œ í…ŒìŠ¤íŠ¸ (ë¹ ë¥¸ í”¼ë“œë°±)
  # ===============================
  backend-test:
    runs-on: ubuntu-latest
    # ì†Œëª¨ëŸ‰ ì˜ˆìƒ: 3-4ë¶„
    defaults:
      run:
        working-directory: ./backend
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: â˜• JDK 17 ìºì‹œ ì„¤ì •
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle  # ğŸš€ Gradle ì˜ì¡´ì„± ìë™ ìºì‹œ
    
    - name: ğŸ”§ Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      run: chmod +x gradlew
    
    # í…ŒìŠ¤íŠ¸ë§Œ ë¹ ë¥´ê²Œ ì‹¤í–‰ (ë¹Œë“œëŠ” ë³„ë„)
    - name: ğŸ§ª ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: ./gradlew test --parallel --build-cache
      env:
        SPRING_PROFILES_ACTIVE: local
    
    # í…ŒìŠ¤íŠ¸ ê²°ê³¼ë§Œ ì—…ë¡œë“œ (ì‹¤íŒ¨ ì‹œì—ë§Œ)
    - name: ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: test-reports
        path: backend/build/reports/tests/test/
        retention-days: 3  # 3ì¼ë§Œ ë³´ê´€

  # ===============================
  # ğŸ—ï¸ ë¹Œë“œ & ë°°í¬ (main ë¸Œëœì¹˜ë§Œ)
  # ===============================
  deploy:
    needs: backend-test  # í…ŒìŠ¤íŠ¸ ì„±ê³µ ì‹œì—ë§Œ ì‹¤í–‰
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    # ì†Œëª¨ëŸ‰ ì˜ˆìƒ: 6-8ë¶„
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    # ===============================
    # ğŸ¨ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ & ë°°í¬
    # ===============================
    - name: ğŸŸ¢ Node.js ìºì‹œ ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: ./frontend/package-lock.json
    
    - name: ğŸ“¦ í”„ë¡ íŠ¸ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜
      working-directory: ./frontend
      run: npm ci --only=production  # dev ì˜ì¡´ì„± ì œì™¸
    
    - name: ğŸ—ï¸ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ
      working-directory: ./frontend  
      run: npm run build
      env:
        VITE_API_URL: ${{ secrets.BACKEND_URL }}
    
    - name: ğŸš€ GitHub Pages ë°°í¬
      uses: peaceiris/actions-gh-pages@v4  # ìµœì‹  ë²„ì „ ì‚¬ìš©
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./frontend/dist
        force_orphan: true  # íˆìŠ¤í† ë¦¬ ì •ë¦¬ë¡œ ìš©ëŸ‰ ì ˆì•½
    
    # ===============================
    # â˜• ë°±ì—”ë“œ ë¹Œë“œ & Railway ë°°í¬
    # ===============================
    - name: â˜• JDK 17 ìºì‹œ ì„¤ì •
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
    
    - name: ğŸ”§ Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      working-directory: ./backend
      run: chmod +x gradlew
    
    - name: ğŸ—ï¸ JAR ë¹Œë“œ (í…ŒìŠ¤íŠ¸ ì œì™¸)
      working-directory: ./backend
      run: ./gradlew bootJar -x test --parallel --build-cache
      env:
        SPRING_PROFILES_ACTIVE: prod
    
    # ===============================
    # ğŸš‚ Railway ì§ì ‘ ë°°í¬ (Docker ì—†ì´)
    # ===============================
    - name: ğŸš‚ Railway ë°°í¬
      working-directory: ./backend
      run: |
        # Railway CLI ì„¤ì¹˜
        npm install -g @railway/cli@latest
        
        # Railway ë¡œê·¸ì¸ ë° ë°°í¬
        railway login --token ${{ secrets.RAILWAY_TOKEN }}
        railway link ${{ secrets.RAILWAY_PROJECT_ID }}
        
        # JAR íŒŒì¼ ì§ì ‘ ì—…ë¡œë“œ ë°°í¬ (Docker ë¹Œë“œ ìŠ¤í‚µ)
        railway up --detach
        
        echo "âœ… ë°°í¬ ì™„ë£Œ!"
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}

# ===============================
# ğŸ“Š ì˜ˆìƒ ì†Œëª¨ëŸ‰: 9-12ë¶„ (40% ì ˆì•½!)
# ===============================
# - ì´ì „: 17-22ë¶„
# - ìµœì í™” í›„: 9-12ë¶„  
# - ì›” 100íšŒ ë°°í¬: 1000ë¶„ (ì—¬ìœ ë¡­ê²Œ ì‚¬ìš© ê°€ëŠ¥)
# ===============================